rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper Functions ───────────────────────────────────
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() &&
             get(/databases/$(database)/documents/user_profiles/$(request.auth.uid)).data.role == 'admin';
    }

    // Team-based access: allows if doc userId matches user's team_id
    function isTeamOwner(docUserId) {
      return isSignedIn() && (
        docUserId == request.auth.uid ||
        docUserId == get(/databases/$(database)/documents/user_profiles/$(request.auth.uid)).data.team_id
      );
    }

    // ─── User Profiles ─────────────────────────────────────
    match /user_profiles/{userId} {
      allow get: if isOwner(userId);
      allow read, write: if isAdmin();
    }

    // ─── App Data (settings, mappings, etc.) ────────────────
    match /app_data/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        (isTeamOwner(resource.data.userId)) ||
        (!('userId' in resource.data)) ||
        isAdmin()
      );
    }

    // ─── Order Files ────────────────────────────────────────
    match /order_files/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isTeamOwner(resource.data.userId) ||
        !('userId' in resource.data) ||
        isAdmin()
      );
    }

    // ─── Import Logs ────────────────────────────────────────
    match /import_logs/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isTeamOwner(resource.data.userId) ||
        !('userId' in resource.data) ||
        isAdmin()
      );
    }

    // ─── Marketing History (ad spend) ───────────────────────
    match /marketing_history/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isTeamOwner(resource.data.userId) ||
        !('userId' in resource.data) ||
        isAdmin()
      );
    }

    // ─── Sunny Modules (ownership-checked) ──────────────────
    match /sunny_profiles/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isTeamOwner(resource.data.userId) ||
        isAdmin()
      );
    }
    match /sunny_accounts/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isTeamOwner(resource.data.userId) ||
        isAdmin()
      );
    }
    match /sunny_settings/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isTeamOwner(resource.data.userId) ||
        isAdmin()
      );
    }
    match /sunny_exclusions/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isTeamOwner(resource.data.userId) ||
        isAdmin()
      );
    }

    // ─── Territory Carriers (read: all, write: admin) ───────
    match /territory_carriers/{id} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ─── Log Pose Projections (ownership-checked) ───────────
    match /logpose_projections/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        isTeamOwner(resource.data.userId) ||
        isAdmin()
      );
    }
  }
}
